# Minimal atlasnetsdk stage
FROM ubuntu:24.04 AS runner
WORKDIR /atlasnet
RUN apt-get update && apt-get install -y libatomic1 binutils
COPY ./.stage /atlasnet

FROM scratch AS atlasnetsdk
COPY ./.stage /atlasnet

FROM runner AS shard
COPY --from=atlasnetsdk /atlasnet/shard /atlasnet/shard
ENTRYPOINT [ "/atlasnet/shard" ]

FROM runner AS watchdog
COPY --from=atlasnetsdk /atlasnet/watchdog /atlasnet/watchdog
ENTRYPOINT [ "/atlasnet/watchdog" ]

FROM runner AS proxy
COPY --from=atlasnetsdk /atlasnet/proxy /atlasnet/proxy
ENTRYPOINT [ "/atlasnet/proxy" ]

FROM node:20-alpine AS cartograph
RUN apk add npm nodejs

COPY --from=atlasnetsdk /atlasnet/cartograph /atlasnet/
WORKDIR /atlasnet/cartograph
ENTRYPOINT ["sh", "-c", "npm install && npm run dev:all"]